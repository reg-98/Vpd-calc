<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grow App</title>
<style>
  body { font-family: sans-serif; margin: 0; padding: 1rem; background: #f0f2f5; }
  .card { background: #fff; padding: 1rem; margin: 1rem 0; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);}
  .timeline { display: flex; margin: 1rem 0; }
  .timeline div { flex: 1; text-align: center; padding: 0.5rem; position: relative; }
  .timeline div:not(:last-child)::after { content:""; position:absolute; top:50%; right:0; width:2px; height:50%; background:#ccc; transform:translateY(-50%);}
  .current { background: #dff7d8; font-weight: bold; }
  .history-table { width:100%; border-collapse: collapse; }
  .history-table th, .history-table td { border: 1px solid #ddd; padding: 0.5rem; text-align:center;}
  .low { background: #ffe5e5; }
  .high { background: #e5f7ff; }
</style>
</head>
<body>

<h1>ðŸ’§ Grow Environment Dashboard</h1>

<div class="card" id="timelineCard">
  <h2>ðŸŒ± Stage Timeline</h2>
  <div class="timeline" id="timeline"></div>
  <p id="timelineInfo"></p>
</div>

<div class="card">
  <h2>Measure & Calculate VPD</h2>
  <label>Temperature (Â°C): <input type="number" id="temp"></label>
  <label>Humidity (%): <input type="number" id="rh"></label>
  <button id="calcBtn">Calculate</button>
  <div id="vpdResult"></div>
</div>

<div class="card">
  <h2>ðŸ“ˆ Past 7 Readings</h2>
  <table class="history-table" id="historyTable">
    <thead><tr><th>Date</th><th>Temp</th><th>RH</th><th>VPD</th><th>Status</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
const STAGE_LENGTHS = { veg: 32, flower: 56, flush: 7 };
const IDEAL_VPD = { veg: [0.8, 1.2], flower: [1.0, 1.4], flush: [1.0, 1.3] };

function getCycleStart() {
  const saved = localStorage.getItem('cycleStart');
  if (saved) return new Date(saved);
  const d = new Date(); d.setDate(d.getDate() - 32); // default veg start
  localStorage.setItem('cycleStart', d.toISOString());
  return d;
}
const cycleStart = getCycleStart();

function computeStage(dayCount) {
  if (dayCount < STAGE_LENGTHS.veg) return ['veg', STAGE_LENGTHS.veg-dayCount];
  if (dayCount < STAGE_LENGTHS.veg+STAGE_LENGTHS.flower) return ['flower', STAGE_LENGTHS.veg+STAGE_LENGTHS.flower-dayCount];
  return ['flush', STAGE_LENGTHS.veg+STAGE_LENGTHS.flower+STAGE_LENGTHS.flush-dayCount];
}

function updateTimeline() {
  const today = new Date();
  const dayCount = Math.floor((today - cycleStart)/86400000);
  const [stage, daysLeft] = computeStage(dayCount);

  const stages = ['veg','flower','flush'];
  const labels = { veg:'Veg', flower:'Flower', flush:'Flush' };
  const container = document.getElementById('timeline');
  container.innerHTML = '';
  stages.forEach(s => {
    const div = document.createElement('div');
    div.className = s===stage?'current':'';
    div.textContent = `${labels[s]} (${STAGE_LENGTHS[s]}d)`;
    container.appendChild(div);
  });
  document.getElementById('timelineInfo').textContent = 
    `Day ${dayCount} â†’ ${labels[stage]} stage, ${daysLeft} days to next stage.`;
}

function calcVPD(temp, rh) {
  const svp = 0.6108 * Math.exp((17.27 * temp)/(temp + 237.3));
  const avp = svp * (rh/100);
  const vpd = svp - avp;
  return parseFloat(vpd.toFixed(2));
}

function getAdvice(stage, vpd) {
  const [min, max] = IDEAL_VPD[stage];
  if (vpd < min) return { status:'low', advice:`Raise humidity or lower temp to boost VPD to at least ${min}` };
  if (vpd > max) return { status:'high', advice:`Lower humidity or raise temp to reduce VPD below ${max}` };
  return { status:'ideal', advice:'VPD is great for this stage ðŸ‘' };
}

function loadHistory() {
  return JSON.parse(localStorage.getItem('history')||'[]');
}

function saveHistory(entry) {
  const h = loadHistory();
  h.unshift(entry);
  localStorage.setItem('history', JSON.stringify(h.slice(0,7)));
}

function renderHistory() {
  const tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML = '';
  loadHistory().forEach(e => {
    const row = tbody.insertRow();
    row.insertCell().textContent = e.date;
    row.insertCell().textContent = e.temp;
    row.insertCell().textContent = e.rh;
    row.insertCell().textContent = e.vpd;
    const advice = row.insertCell();
    advice.textContent = e.status;
    advice.className = e.status;
  });
}

document.getElementById('calcBtn').addEventListener('click', () => {
  const t = parseFloat(document.getElementById('temp').value);
  const rh = parseFloat(document.getElementById('rh').value);
  if (isNaN(t)||isNaN(rh)) return alert('Please enter temp & RH');
  const vpd = calcVPD(t, rh);
  const dayCount = Math.floor((new Date() - cycleStart)/86400000);
  const [stage] = computeStage(dayCount);
  const { status, advice } = getAdvice(stage, vpd);
  document.getElementById('vpdResult').innerHTML = 
    `VPD: <strong>${vpd}â€¯kPa</strong> â†’ <span class="${status}">${status.toUpperCase()}</span><br>${advice}`;

  const entry = { date:new Date().toLocaleDateString(), temp:t, rh, vpd, status };
  saveHistory(entry);
  renderHistory();
});

updateTimeline();
renderHistory();
</script>

</body>
</html>